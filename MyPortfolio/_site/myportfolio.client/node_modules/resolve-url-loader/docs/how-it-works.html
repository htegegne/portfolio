<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>How it works | portfolio</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="How it works" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/myportfolio.client/node_modules/resolve-url-loader/docs/how-it-works.html" />
<meta property="og:url" content="http://localhost:4000/myportfolio.client/node_modules/resolve-url-loader/docs/how-it-works.html" />
<meta property="og:site_name" content="portfolio" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="How it works" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","headline":"How it works","url":"http://localhost:4000/myportfolio.client/node_modules/resolve-url-loader/docs/how-it-works.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=059dd2210d8f0fb8d42af0cbb5c1b29e59b98886">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">portfolio</a></h1>
      

      <h1 id="how-it-works">How it works</h1>

<h2 id="the-problem">The problem</h2>

<p>The <code class="language-plaintext highlighter-rouge">resolve-url-loader</code> is typically used where SASS source files are transpiled to CSS. CSS being a format that webpack can readily ingest. So let‚Äôs look at a basic example where the structure is basically CSS but is composed using SASS features.</p>

<p>Working backwards, this is the final CSS we are after. Just a single rule with a single declaration.</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.cool</span> <span class="p">{</span>
  <span class="nl">background-image</span><span class="p">:</span> <span class="sx">url(cool.png)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When using SASS it‚Äôs common for rules to come from different <a href="https://sass-lang.com/documentation/at-rules/import#partials">partials</a>, and for declarations to be composed using mixins and functions. Consider this more complicated project with imported files.</p>

<p><img src="detailed-problem.svg" alt="the detailed problem" width="363px" height="651px" /></p>

<p>All the subdirectories here contributed something to the rule, so we could reasonably place the asset in any of them. And any of these locations might be the ‚Äúcorrect‚Äù to our way of thinking.</p>

<p>There could actually be a separate <code class="language-plaintext highlighter-rouge">cool.png</code> in each of the subdirectories! ü§Ø In that case, which one gets used?</p>

<p>The answer: none. üòû Webpack expects asset paths to be relative to the root SASS file <code class="language-plaintext highlighter-rouge">src/styles.scss</code>. So for the CSS <code class="language-plaintext highlighter-rouge">url(cool.png)</code> it will look for <code class="language-plaintext highlighter-rouge">src/cool.png</code> which is not present. üí•</p>

<p>All our assets are in subdirecties <code class="language-plaintext highlighter-rouge">src/foo/cool.png</code> or <code class="language-plaintext highlighter-rouge">src/foo/bar/cool.png</code> or <code class="language-plaintext highlighter-rouge">src/foo/bar/baz/cool.png</code>. We need to re-write the <code class="language-plaintext highlighter-rouge">url()</code> to point to the one we intend. But right now that‚Äôs pretty ambiguous.</p>

<p>Worse still, Webpack doesn‚Äôt know any of these nested SCSS files were part of the SASS composition. Meaing it doesn‚Äôt know there <em>are</em> nested directories in the first place. How do we rewite to something we don‚Äôt know about?</p>

<p><strong>The problem:</strong> How to identify contributing directectories and look for the asset in those directories in some well-defined priority order?</p>

<p><strong>The crux:</strong> How to identify what contributed to the SASS compilation, internally and post factum, but from within Webpack? üò´</p>

<h2 id="the-solution">The solution</h2>

<p>Sourcemaps! üòÉ</p>

<p>Wait, don‚Äôt run away! Sourcemaps might sound scary, but they solve our problem reasonably well. üëç</p>

<p>The SASS compiler source-map can tell us which original SCSS file contributed each character in the resulting CSS.</p>

<p>The SASS source-map is also something we can access from within Webpack.</p>

<h3 id="concept">concept</h3>

<p>Continuing with the example let‚Äôs compile SASS on the command line. You can do this several different ways but I prefer <a href="https://blog.npmjs.org/post/162869356040/introducing-npx-an-npm-package-runner">npx</a>.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> npx node-sass src/styles.scss <span class="nt">--output</span> <span class="nb">.</span> <span class="nt">--output-style</span> expanded <span class="nt">--source-map</span> <span class="nb">true</span>
</code></pre></div></div>

<p>Using the experimental <code class="language-plaintext highlighter-rouge">sourcemap-to-string</code> package (also in this repository) we can visualise the SASS source on the left vs the output CSS on the right.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>src/styles.scss                                                                
-------------------------------------------------------------------------------
                                                                               
src/foo/_partial.scss                                                          
-------------------------------------------------------------------------------
3:01 .cool‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 1:01 .cool‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë
3:06 ‚ñë‚ñë‚ñë‚ñë‚ñë ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 1:06 ‚ñë‚ñë‚ñë‚ñë‚ñë ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë
3:07 ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë{‚èé                           1:07 ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë{‚èé                          
       @include cool-background-image;‚èé        ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë
     }‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë      ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë
-:-- ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 3:02 ‚ñë‚èé                                
     ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë      ‚èé                                 
     ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë      /*# sourceMappingURL=styles.css.ma
     ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë      p */‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë
                                                                               
src/foo/bar/_mixins.scss                                                       
-------------------------------------------------------------------------------
4:03 ‚ñë‚ñëbackground-image‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 2:03 ‚ñë‚ñëbackground-image‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë
4:19 ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë: get-url("cool" 2:19 ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë: ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë
     );‚èé                                     ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë
     }‚èé                                      ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë
                                                                               
src/foo/bar/baz/_functions.scss                                                
-------------------------------------------------------------------------------
2:11 ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñëurl(#‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 2:21 ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñëurl(cool.png)‚ñë
2:16 ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë{$temp}.png);‚èé      2:34 ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë;
     }‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë      ‚èé                                 
     ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë      }‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë
</code></pre></div></div>

<p>As expected, the pure CSS portions are essentially the same in the source and the output.</p>

<p>Meanwhile the indirect  <code class="language-plaintext highlighter-rouge">@mixin</code> and <code class="language-plaintext highlighter-rouge">funtion</code> substitutes values into the output. But we can still clearly see where in the source that final value originated from.</p>

<h3 id="algorithm">algorithm</h3>

<p>Now we know the original SCSS sources we can use a CSS parser such as <code class="language-plaintext highlighter-rouge">postcss</code> to process all the declaration values that contain <code class="language-plaintext highlighter-rouge">url()</code> and rewrite any file paths we find there.</p>

<ol>
  <li>Enumerate all declaration values</li>
  <li>Split the value into path substrings</li>
  <li>Evaluate the source-map at that location, find the original source file</li>
  <li>Rebase the path to that original source file.</li>
</ol>

<p>For our example, this algorithm will always give us the asset located in the <code class="language-plaintext highlighter-rouge">baz</code> subdirectory. Clearly evaluating the source-map at just one location is not enough. Any of the directories that contributed source files to the rule-set might be considered the ‚Äúcorrect‚Äù place to store the asset and all these files contributed different parts of the rule-set, not just the declaration value.</p>

<p>We stop short of evaluating the source-map for <em>every characer</em> in the rule-set and instead we chose a small number of meaningful points.</p>

<table>
  <thead>
    <tr>
      <th>¬†</th>
      <th>label</th>
      <th>sampling location</th>
      <th>in the example</th>
      <th>implies asset</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>subString</td>
      <td>start of <strong>argument</strong> to the <code class="language-plaintext highlighter-rouge">url()</code></td>
      <td><code class="language-plaintext highlighter-rouge">c</code> in <code class="language-plaintext highlighter-rouge">cool.png</code></td>
      <td><code class="language-plaintext highlighter-rouge">src/foo/bar/baz/cool.png</code></td>
    </tr>
    <tr>
      <td>2</td>
      <td>value</td>
      <td>start of <strong>value</strong> in the declaration</td>
      <td><code class="language-plaintext highlighter-rouge">u</code> in <code class="language-plaintext highlighter-rouge">url(...)</code></td>
      <td><code class="language-plaintext highlighter-rouge">src/foo/bar/baz/cool.png</code></td>
    </tr>
    <tr>
      <td>3</td>
      <td>property</td>
      <td>start of <strong>property</strong> in the declaration</td>
      <td><code class="language-plaintext highlighter-rouge">b</code> in <code class="language-plaintext highlighter-rouge">background-image</code></td>
      <td><code class="language-plaintext highlighter-rouge">src/foo/bar/cool.png</code></td>
    </tr>
    <tr>
      <td>4</td>
      <td>selector</td>
      <td>start of <strong>selector</strong> in the rule-set</td>
      <td><code class="language-plaintext highlighter-rouge">.</code> in <code class="language-plaintext highlighter-rouge">.selector</code></td>
      <td><code class="language-plaintext highlighter-rouge">src/foo/cool.png</code></td>
    </tr>
  </tbody>
</table>

<p>These locations are tested in order. If an asset of the correct filename is found then we break and use that result.</p>

<p>Note it is a quirk of the example that the <code class="language-plaintext highlighter-rouge">value</code> and <code class="language-plaintext highlighter-rouge">subString</code> locations imply the same file. In a more complex example this may not be true.</p>

<p>If necessary the order can be customised or a custom file search (starting at each location) be implemented. Refer to the <a href="/myportfolio.client/node_modules/resolve-url-loader/docs/advanced-features.html">advanced features</a>.</p>

<h3 id="webpack">webpack</h3>

<p>To operate on the <code class="language-plaintext highlighter-rouge">sass-loader</code> output, both <strong>CSS</strong> and <strong>source-map</strong>, we introduce <code class="language-plaintext highlighter-rouge">resolve-url-loader</code> containing the algorithm above.</p>

<p>The <code class="language-plaintext highlighter-rouge">resolve-url-loader</code> rewrites asset paths found in <code class="language-plaintext highlighter-rouge">url()</code> notation using the <code class="language-plaintext highlighter-rouge">postcss</code> parser.</p>

<p>This webpack configuration outlines some important points.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">rules</span><span class="p">:</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="na">test</span><span class="p">:</span> <span class="sr">/</span><span class="se">\.</span><span class="sr">scss$/</span><span class="p">,</span>
    <span class="na">use</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="na">loader</span><span class="p">:</span> <span class="dl">'</span><span class="s1">css-loader</span><span class="dl">'</span>  <span class="c1">// &lt;-- assets are identified here</span>
      <span class="p">},</span> <span class="p">{</span>
        <span class="na">loader</span><span class="p">:</span> <span class="dl">'</span><span class="s1">resolve-url-loader</span><span class="dl">'</span>  <span class="c1">// &lt;-- receives CSS and source-map from SASS compile</span>
      <span class="p">},</span> <span class="p">{</span>
        <span class="na">loader</span><span class="p">:</span> <span class="dl">'</span><span class="s1">sass-loader</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">options</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">sourceMap</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>  <span class="c1">// &lt;-- IMPORTANT!</span>
          <span class="na">sourceMapContents</span><span class="p">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">],</span>
  <span class="p">},</span>
  <span class="p">...</span>
  <span class="p">{</span>
    <span class="nl">test</span><span class="p">:</span> <span class="sr">/</span><span class="se">\.</span><span class="sr">png$/</span><span class="p">,</span>  <span class="c1">// &lt;-- assets needs their own loader configuration</span>
    <span class="nx">use</span><span class="p">:</span> <span class="p">[</span> <span class="p">...</span> <span class="p">]</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre></div></div>

<p>Its essential to explicitly configure the <code class="language-plaintext highlighter-rouge">sass-loader</code> for <code class="language-plaintext highlighter-rouge">sourceMap: true</code>. That way we definitely get a sourcemap from upstream SASS loader all the time, not just in developement mode or where <code class="language-plaintext highlighter-rouge">devtool</code> is used.</p>

<p>Once the CSS reaches the <code class="language-plaintext highlighter-rouge">css-loader</code> webpack becomes aware of each of the asset files and will try to separately load and process them. You will need more Webpack configuration to make that work. Refer to the <a href="/myportfolio.client/node_modules/resolve-url-loader/docs/troubleshooting.html">troubleshooting docs</a> before raising an issue.</p>

<h3 id="beyond">beyond‚Ä¶?</h3>

<p>The implementation here is limited to the webpack loader but it‚Äôs plausible the algorithm could be realised as a <code class="language-plaintext highlighter-rouge">postcss</code> plugin in isolation using the <a href="https://postcss.org/api/#postcss-input">root.input.map</a> property to access the incomming source-map.</p>

<p>As a separate plugin it could be combined with other plugins in a single <code class="language-plaintext highlighter-rouge">postcss-loader</code> step. Processing multiple plugins together in this way without reparsing would arguably be more efficient.</p>

<p>However as a Webpack loader we have full access to the loader API and the virtual file-system. This means maximum compatibility with <code class="language-plaintext highlighter-rouge">webpack-dev-server</code> and the rest of the Webpack ecosystem.</p>


      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
  </body>
</html>
