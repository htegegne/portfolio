<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>IndexedDB with usability. | portfolio</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="IndexedDB with usability." />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/myportfolio.client/node_modules/idb/" />
<meta property="og:url" content="http://localhost:4000/myportfolio.client/node_modules/idb/" />
<meta property="og:site_name" content="portfolio" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="IndexedDB with usability." />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","headline":"IndexedDB with usability.","url":"http://localhost:4000/myportfolio.client/node_modules/idb/"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=059dd2210d8f0fb8d42af0cbb5c1b29e59b98886">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">portfolio</a></h1>
      

      <h1 id="indexeddb-with-usability">IndexedDB with usability.</h1>

<p>This is a tiny (~1.06kB brotli’d) library that mostly mirrors the IndexedDB API, but with small improvements that make a big difference to usability.</p>

<ol>
  <li><a href="#installation">Installation</a></li>
  <li><a href="#changes">Changes</a></li>
  <li><a href="#browser-support">Browser support</a></li>
  <li><a href="#api">API</a>
    <ol>
      <li><a href="#opendb"><code class="language-plaintext highlighter-rouge">openDB</code></a></li>
      <li><a href="#deletedb"><code class="language-plaintext highlighter-rouge">deleteDB</code></a></li>
      <li><a href="#unwrap"><code class="language-plaintext highlighter-rouge">unwrap</code></a></li>
      <li><a href="#wrap"><code class="language-plaintext highlighter-rouge">wrap</code></a></li>
      <li><a href="#general-enhancements">General enhancements</a></li>
      <li><a href="#idbdatabase-enhancements"><code class="language-plaintext highlighter-rouge">IDBDatabase</code> enhancements</a></li>
      <li><a href="#idbtransaction-enhancements"><code class="language-plaintext highlighter-rouge">IDBTransaction</code> enhancements</a></li>
      <li><a href="#idbcursor-enhancements"><code class="language-plaintext highlighter-rouge">IDBCursor</code> enhancements</a></li>
      <li><a href="#async-iterators">Async iterators</a></li>
    </ol>
  </li>
  <li><a href="#examples">Examples</a></li>
  <li><a href="#typescript">TypeScript</a></li>
</ol>

<h1 id="installation">Installation</h1>

<h2 id="using-npm">Using npm</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install </span>idb
</code></pre></div></div>

<p>Then, assuming you’re using a module-compatible system (like webpack, Rollup etc):</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">openDB</span><span class="p">,</span> <span class="nx">deleteDB</span><span class="p">,</span> <span class="nx">wrap</span><span class="p">,</span> <span class="nx">unwrap</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">idb</span><span class="dl">'</span><span class="p">;</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">doDatabaseStuff</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">openDB</span><span class="p">(</span><span class="err">…</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="directly-in-a-browser">Directly in a browser</h2>

<h3 id="using-the-modules-method-directly-via-jsdelivr">Using the modules method directly via jsdelivr:</h3>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"module"</span><span class="nt">&gt;</span>
  <span class="k">import</span> <span class="p">{</span> <span class="nx">openDB</span><span class="p">,</span> <span class="nx">deleteDB</span><span class="p">,</span> <span class="nx">wrap</span><span class="p">,</span> <span class="nx">unwrap</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">https://cdn.jsdelivr.net/npm/idb@7/+esm</span><span class="dl">'</span><span class="p">;</span>

  <span class="k">async</span> <span class="kd">function</span> <span class="nx">doDatabaseStuff</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">openDB</span><span class="p">(</span><span class="err">…</span><span class="p">);</span>
  <span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<h3 id="using-external-script-reference">Using external script reference</h3>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script&gt;</span>
  <span class="k">async</span> <span class="kd">function</span> <span class="nx">doDatabaseStuff</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">idb</span><span class="p">.</span><span class="nx">openDB</span><span class="p">(</span><span class="err">…</span><span class="p">);</span>
  <span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p>A global, <code class="language-plaintext highlighter-rouge">idb</code>, will be created, containing all exports of the module version.</p>

<h1 id="changes">Changes</h1>

<p><a href="/myportfolio.client/node_modules/idb/CHANGELOG.html">See details of (potentially) breaking changes</a>.</p>

<h1 id="browser-support">Browser support</h1>

<p>This library targets modern browsers, as in Chrome, Firefox, Safari, and other browsers that use those engines, such as Edge. IE is not supported.</p>

<p>If you want to target much older versions of those browsers, you can transpile the library using something like <a href="https://babeljs.io/">Babel</a>. You can’t transpile the library for IE, as it relies on a proper implementation of <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy">JavaScript proxies</a>.</p>

<h1 id="api">API</h1>

<h2 id="opendb"><code class="language-plaintext highlighter-rouge">openDB</code></h2>

<p>This method opens a database, and returns a promise for an enhanced <a href="https://w3c.github.io/IndexedDB/#database-interface"><code class="language-plaintext highlighter-rouge">IDBDatabase</code></a>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">openDB</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">version</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">upgrade</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="nx">oldVersion</span><span class="p">,</span> <span class="nx">newVersion</span><span class="p">,</span> <span class="nx">transaction</span><span class="p">,</span> <span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// …</span>
  <span class="p">},</span>
  <span class="nx">blocked</span><span class="p">(</span><span class="nx">currentVersion</span><span class="p">,</span> <span class="nx">blockedVersion</span><span class="p">,</span> <span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// …</span>
  <span class="p">},</span>
  <span class="nx">blocking</span><span class="p">(</span><span class="nx">currentVersion</span><span class="p">,</span> <span class="nx">blockedVersion</span><span class="p">,</span> <span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// …</span>
  <span class="p">},</span>
  <span class="nx">terminated</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// …</span>
  <span class="p">},</span>
<span class="p">});</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">name</code>: Name of the database.</li>
  <li><code class="language-plaintext highlighter-rouge">version</code> (optional): Schema version, or <code class="language-plaintext highlighter-rouge">undefined</code> to open the current version.</li>
  <li><code class="language-plaintext highlighter-rouge">upgrade</code> (optional): Called if this version of the database has never been opened before. Use it to specify the schema for the database. This is similar to the <a href="https://developer.mozilla.org/en-US/docs/Web/API/IDBOpenDBRequest/upgradeneeded_event"><code class="language-plaintext highlighter-rouge">upgradeneeded</code> event</a> in plain IndexedDB.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">db</code>: An enhanced <code class="language-plaintext highlighter-rouge">IDBDatabase</code>.</li>
      <li><code class="language-plaintext highlighter-rouge">oldVersion</code>: Last version of the database opened by the user.</li>
      <li><code class="language-plaintext highlighter-rouge">newVersion</code>: Whatever new version you provided.</li>
      <li><code class="language-plaintext highlighter-rouge">transaction</code>: An enhanced transaction for this upgrade. This is useful if you need to get data from other stores as part of a migration.</li>
      <li><code class="language-plaintext highlighter-rouge">event</code>: The event object for the associated <code class="language-plaintext highlighter-rouge">upgradeneeded</code> event.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">blocked</code> (optional): Called if there are older versions of the database open on the origin, so this version cannot open. This is similar to the <a href="https://developer.mozilla.org/en-US/docs/Web/API/IDBOpenDBRequest/blocked_event"><code class="language-plaintext highlighter-rouge">blocked</code> event</a> in plain IndexedDB.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">currentVersion</code>: Version of the database that’s blocking this one.</li>
      <li><code class="language-plaintext highlighter-rouge">blockedVersion</code>: The version of the database being blocked (whatever version you provided to <code class="language-plaintext highlighter-rouge">openDB</code>).</li>
      <li><code class="language-plaintext highlighter-rouge">event</code>: The event object for the associated <code class="language-plaintext highlighter-rouge">blocked</code> event.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">blocking</code> (optional): Called if this connection is blocking a future version of the database from opening. This is similar to the <a href="https://developer.mozilla.org/en-US/docs/Web/API/IDBDatabase/versionchange_event"><code class="language-plaintext highlighter-rouge">versionchange</code> event</a> in plain IndexedDB.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">currentVersion</code>: Version of the open database (whatever version you provided to <code class="language-plaintext highlighter-rouge">openDB</code>).</li>
      <li><code class="language-plaintext highlighter-rouge">blockedVersion</code>: The version of the database that’s being blocked.</li>
      <li><code class="language-plaintext highlighter-rouge">event</code>: The event object for the associated <code class="language-plaintext highlighter-rouge">versionchange</code> event.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">terminated</code> (optional): Called if the browser abnormally terminates the connection, but not on regular closures like calling <code class="language-plaintext highlighter-rouge">db.close()</code>. This is similar to the <a href="https://developer.mozilla.org/en-US/docs/Web/API/IDBDatabase/close_event"><code class="language-plaintext highlighter-rouge">close</code> event</a> in plain IndexedDB.</li>
</ul>

<h2 id="deletedb"><code class="language-plaintext highlighter-rouge">deleteDB</code></h2>

<p>Deletes a database.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="nx">deleteDB</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">blocked</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// …</span>
  <span class="p">},</span>
<span class="p">});</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">name</code>: Name of the database.</li>
  <li><code class="language-plaintext highlighter-rouge">blocked</code> (optional): Called if the database already exists and there are open connections that don’t close in response to a versionchange event, the request will be blocked until they all close.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">currentVersion</code>: Version of the database that’s blocking the delete operation.</li>
      <li><code class="language-plaintext highlighter-rouge">event</code>: The event object for the associated ‘versionchange’ event.</li>
    </ul>
  </li>
</ul>

<h2 id="unwrap"><code class="language-plaintext highlighter-rouge">unwrap</code></h2>

<p>Takes an enhanced IndexedDB object and returns the plain unmodified one.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">unwrapped</span> <span class="o">=</span> <span class="nx">unwrap</span><span class="p">(</span><span class="nx">wrapped</span><span class="p">);</span>
</code></pre></div></div>

<p>This is useful if, for some reason, you want to drop back into plain IndexedDB. Promises will also be converted back into <code class="language-plaintext highlighter-rouge">IDBRequest</code> objects.</p>

<h2 id="wrap"><code class="language-plaintext highlighter-rouge">wrap</code></h2>

<p>Takes an IDB object and returns a version enhanced by this library.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">wrapped</span> <span class="o">=</span> <span class="nx">wrap</span><span class="p">(</span><span class="nx">unwrapped</span><span class="p">);</span>
</code></pre></div></div>

<p>This is useful if some third party code gives you an <code class="language-plaintext highlighter-rouge">IDBDatabase</code> object and you want it to have the features of this library.</p>

<p>This doesn’t work with <code class="language-plaintext highlighter-rouge">IDBCursor</code>, <a href="https://github.com/w3c/IndexedDB/issues/255">due to missing primitives</a>. Also, if you wrap an <code class="language-plaintext highlighter-rouge">IDBTransaction</code>, <code class="language-plaintext highlighter-rouge">tx.store</code> and <code class="language-plaintext highlighter-rouge">tx.objectStoreNames</code> won’t work in Edge. To avoid these issues, wrap the <code class="language-plaintext highlighter-rouge">IDBDatabase</code> object, and use the wrapped object to create a new transaction.</p>

<h2 id="general-enhancements">General enhancements</h2>

<p>Once you’ve opened the database the API is the same as IndexedDB, except for a few changes to make things easier.</p>

<p>Firstly, any method that usually returns an <code class="language-plaintext highlighter-rouge">IDBRequest</code> object will now return a promise for the result.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="nx">storeName</span><span class="p">).</span><span class="nx">objectStore</span><span class="p">(</span><span class="nx">storeName</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">store</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="promises--throwing">Promises &amp; throwing</h3>

<p>The library turns all <code class="language-plaintext highlighter-rouge">IDBRequest</code> objects into promises, but it doesn’t know in advance which methods may return promises.</p>

<p>As a result, methods such as <code class="language-plaintext highlighter-rouge">store.put</code> may throw instead of returning a promise.</p>

<p>If you’re using async functions, there’s no observable difference.</p>

<h3 id="transaction-lifetime">Transaction lifetime</h3>

<p>TL;DR: <strong>Do not <code class="language-plaintext highlighter-rouge">await</code> other things between the start and end of your transaction</strong>, otherwise the transaction will close before you’re done.</p>

<p>An IDB transaction auto-closes if it doesn’t have anything left do once microtasks have been processed. As a result, this works fine:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">tx</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="dl">'</span><span class="s1">keyval</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">readwrite</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">objectStore</span><span class="p">(</span><span class="dl">'</span><span class="s1">keyval</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">val</span> <span class="o">=</span> <span class="p">(</span><span class="k">await</span> <span class="nx">store</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">counter</span><span class="dl">'</span><span class="p">))</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">await</span> <span class="nx">store</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">val</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="dl">'</span><span class="s1">counter</span><span class="dl">'</span><span class="p">);</span>
<span class="k">await</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">done</span><span class="p">;</span>
</code></pre></div></div>

<p>But this doesn’t:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">tx</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="dl">'</span><span class="s1">keyval</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">readwrite</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">objectStore</span><span class="p">(</span><span class="dl">'</span><span class="s1">keyval</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">val</span> <span class="o">=</span> <span class="p">(</span><span class="k">await</span> <span class="nx">store</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">counter</span><span class="dl">'</span><span class="p">))</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">// This is where things go wrong:</span>
<span class="kd">const</span> <span class="nx">newVal</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">/increment?val=</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">val</span><span class="p">);</span>
<span class="c1">// And this throws an error:</span>
<span class="k">await</span> <span class="nx">store</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">newVal</span><span class="p">,</span> <span class="dl">'</span><span class="s1">counter</span><span class="dl">'</span><span class="p">);</span>
<span class="k">await</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">done</span><span class="p">;</span>
</code></pre></div></div>

<p>In this case, the transaction closes while the browser is fetching, so <code class="language-plaintext highlighter-rouge">store.put</code> fails.</p>

<h2 id="idbdatabase-enhancements"><code class="language-plaintext highlighter-rouge">IDBDatabase</code> enhancements</h2>

<h3 id="shortcuts-to-getset-from-an-object-store">Shortcuts to get/set from an object store</h3>

<p>It’s common to create a transaction for a single action, so helper methods are included for this:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Get a value from a store:</span>
<span class="kd">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">storeName</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
<span class="c1">// Set a value in a store:</span>
<span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">storeName</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
</code></pre></div></div>

<p>The shortcuts are: <code class="language-plaintext highlighter-rouge">get</code>, <code class="language-plaintext highlighter-rouge">getKey</code>, <code class="language-plaintext highlighter-rouge">getAll</code>, <code class="language-plaintext highlighter-rouge">getAllKeys</code>, <code class="language-plaintext highlighter-rouge">count</code>, <code class="language-plaintext highlighter-rouge">put</code>, <code class="language-plaintext highlighter-rouge">add</code>, <code class="language-plaintext highlighter-rouge">delete</code>, and <code class="language-plaintext highlighter-rouge">clear</code>. Each method takes a <code class="language-plaintext highlighter-rouge">storeName</code> argument, the name of the object store, and the rest of the arguments are the same as the equivalent <code class="language-plaintext highlighter-rouge">IDBObjectStore</code> method.</p>

<h3 id="shortcuts-to-get-from-an-index">Shortcuts to get from an index</h3>

<p>The shortcuts are: <code class="language-plaintext highlighter-rouge">getFromIndex</code>, <code class="language-plaintext highlighter-rouge">getKeyFromIndex</code>, <code class="language-plaintext highlighter-rouge">getAllFromIndex</code>, <code class="language-plaintext highlighter-rouge">getAllKeysFromIndex</code>, and <code class="language-plaintext highlighter-rouge">countFromIndex</code>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Get a value from an index:</span>
<span class="kd">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">getFromIndex</span><span class="p">(</span><span class="nx">storeName</span><span class="p">,</span> <span class="nx">indexName</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
</code></pre></div></div>

<p>Each method takes <code class="language-plaintext highlighter-rouge">storeName</code> and <code class="language-plaintext highlighter-rouge">indexName</code> arguments, followed by the rest of the arguments from the equivalent <code class="language-plaintext highlighter-rouge">IDBIndex</code> method.</p>

<h2 id="idbtransaction-enhancements"><code class="language-plaintext highlighter-rouge">IDBTransaction</code> enhancements</h2>

<h3 id="txstore"><code class="language-plaintext highlighter-rouge">tx.store</code></h3>

<p>If a transaction involves a single store, the <code class="language-plaintext highlighter-rouge">store</code> property will reference that store.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">tx</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="dl">'</span><span class="s1">whatever</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">store</span><span class="p">;</span>
</code></pre></div></div>

<p>If a transaction involves multiple stores, <code class="language-plaintext highlighter-rouge">tx.store</code> is undefined, you need to use <code class="language-plaintext highlighter-rouge">tx.objectStore(storeName)</code> to get the stores.</p>

<h3 id="txdone"><code class="language-plaintext highlighter-rouge">tx.done</code></h3>

<p>Transactions have a <code class="language-plaintext highlighter-rouge">.done</code> promise which resolves when the transaction completes successfully, and otherwise rejects with the <a href="https://developer.mozilla.org/en-US/docs/Web/API/IDBTransaction/error">transaction error</a>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">tx</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="nx">storeName</span><span class="p">,</span> <span class="dl">'</span><span class="s1">readwrite</span><span class="dl">'</span><span class="p">);</span>
<span class="k">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
  <span class="nx">tx</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">foo</span><span class="dl">'</span><span class="p">),</span>
  <span class="nx">tx</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="dl">'</span><span class="s1">world</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">hello</span><span class="dl">'</span><span class="p">),</span>
  <span class="nx">tx</span><span class="p">.</span><span class="nx">done</span><span class="p">,</span>
<span class="p">]);</span>
</code></pre></div></div>

<p>If you’re writing to the database, <code class="language-plaintext highlighter-rouge">tx.done</code> is the signal that everything was successfully committed to the database. However, it’s still beneficial to await the individual operations, as you’ll see the error that caused the transaction to fail.</p>

<h2 id="idbcursor-enhancements"><code class="language-plaintext highlighter-rouge">IDBCursor</code> enhancements</h2>

<p>Cursor advance methods (<code class="language-plaintext highlighter-rouge">advance</code>, <code class="language-plaintext highlighter-rouge">continue</code>, <code class="language-plaintext highlighter-rouge">continuePrimaryKey</code>) return a promise for the cursor, or null if there are no further values to provide.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="nx">storeName</span><span class="p">).</span><span class="nx">store</span><span class="p">.</span><span class="nx">openCursor</span><span class="p">();</span>

<span class="k">while</span> <span class="p">(</span><span class="nx">cursor</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
  <span class="nx">cursor</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">cursor</span><span class="p">.</span><span class="k">continue</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="async-iterators">Async iterators</h2>

<p>Async iterator support isn’t included by default (Edge doesn’t support them). To include them, import <code class="language-plaintext highlighter-rouge">idb/with-async-ittr</code> instead of <code class="language-plaintext highlighter-rouge">idb</code> (this increases the library size to ~1.29kB brotli’d):</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">openDB</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">idb/with-async-ittr</span><span class="dl">'</span><span class="p">;</span>
</code></pre></div></div>

<p>Or <code class="language-plaintext highlighter-rouge">https://cdn.jsdelivr.net/npm/idb@7/build/umd-with-async-ittr.js</code> if you’re using the non-module version.</p>

<p>Now you can iterate over stores, indexes, and cursors:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">tx</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="nx">storeName</span><span class="p">);</span>

<span class="k">for</span> <span class="k">await</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">cursor</span> <span class="k">of</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">store</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// …</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Each yielded object is an <code class="language-plaintext highlighter-rouge">IDBCursor</code>. You can optionally use the advance methods to skip items (within an async iterator they return void):</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">tx</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="nx">storeName</span><span class="p">);</span>

<span class="k">for</span> <span class="k">await</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">cursor</span> <span class="k">of</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">store</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
  <span class="c1">// Skip the next item</span>
  <span class="nx">cursor</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If you don’t manually advance the cursor, <code class="language-plaintext highlighter-rouge">cursor.continue()</code> is called for you.</p>

<p>Stores and indexes also have an <code class="language-plaintext highlighter-rouge">iterate</code> method which has the same signature as <code class="language-plaintext highlighter-rouge">openCursor</code>, but returns an async iterator:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">).</span><span class="nx">store</span><span class="p">.</span><span class="nx">index</span><span class="p">(</span><span class="dl">'</span><span class="s1">author</span><span class="dl">'</span><span class="p">);</span>

<span class="k">for</span> <span class="k">await</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">cursor</span> <span class="k">of</span> <span class="nx">index</span><span class="p">.</span><span class="nx">iterate</span><span class="p">(</span><span class="dl">'</span><span class="s1">Douglas Adams</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="examples">Examples</h1>

<h2 id="keyval-store">Keyval store</h2>

<p>This is very similar to <code class="language-plaintext highlighter-rouge">localStorage</code>, but async. If this is <em>all</em> you need, you may be interested in <a href="https://www.npmjs.com/package/idb-keyval">idb-keyval</a>. You can always upgrade to this library later.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">openDB</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">idb</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">dbPromise</span> <span class="o">=</span> <span class="nx">openDB</span><span class="p">(</span><span class="dl">'</span><span class="s1">keyval-store</span><span class="dl">'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">upgrade</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">createObjectStore</span><span class="p">(</span><span class="dl">'</span><span class="s1">keyval</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">},</span>
<span class="p">});</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="kd">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="nx">dbPromise</span><span class="p">).</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">keyval</span><span class="dl">'</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="kd">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="nx">dbPromise</span><span class="p">).</span><span class="nx">put</span><span class="p">(</span><span class="dl">'</span><span class="s1">keyval</span><span class="dl">'</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nx">del</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="nx">dbPromise</span><span class="p">).</span><span class="k">delete</span><span class="p">(</span><span class="dl">'</span><span class="s1">keyval</span><span class="dl">'</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nx">clear</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="nx">dbPromise</span><span class="p">).</span><span class="nx">clear</span><span class="p">(</span><span class="dl">'</span><span class="s1">keyval</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nx">keys</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="nx">dbPromise</span><span class="p">).</span><span class="nx">getAllKeys</span><span class="p">(</span><span class="dl">'</span><span class="s1">keyval</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="article-store">Article store</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">openDB</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">idb/with-async-ittr.js</span><span class="dl">'</span><span class="p">;</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">demo</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">openDB</span><span class="p">(</span><span class="dl">'</span><span class="s1">Articles</span><span class="dl">'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">upgrade</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Create a store of objects</span>
      <span class="kd">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">createObjectStore</span><span class="p">(</span><span class="dl">'</span><span class="s1">articles</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
        <span class="c1">// The 'id' property of the object will be the key.</span>
        <span class="na">keyPath</span><span class="p">:</span> <span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">,</span>
        <span class="c1">// If it isn't explicitly set, create a value by auto incrementing.</span>
        <span class="na">autoIncrement</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="p">});</span>
      <span class="c1">// Create an index on the 'date' property of the objects.</span>
      <span class="nx">store</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">(</span><span class="dl">'</span><span class="s1">date</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">date</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">},</span>
  <span class="p">});</span>

  <span class="c1">// Add an article:</span>
  <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="dl">'</span><span class="s1">articles</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Article 1</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="dl">'</span><span class="s1">2019-01-01</span><span class="dl">'</span><span class="p">),</span>
    <span class="na">body</span><span class="p">:</span> <span class="dl">'</span><span class="s1">…</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">});</span>

  <span class="c1">// Add multiple articles in one transaction:</span>
  <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">tx</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="dl">'</span><span class="s1">articles</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">readwrite</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
      <span class="nx">tx</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span>
        <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Article 2</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">date</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="dl">'</span><span class="s1">2019-01-01</span><span class="dl">'</span><span class="p">),</span>
        <span class="na">body</span><span class="p">:</span> <span class="dl">'</span><span class="s1">…</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">}),</span>
      <span class="nx">tx</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span>
        <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Article 3</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">date</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="dl">'</span><span class="s1">2019-01-02</span><span class="dl">'</span><span class="p">),</span>
        <span class="na">body</span><span class="p">:</span> <span class="dl">'</span><span class="s1">…</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">}),</span>
      <span class="nx">tx</span><span class="p">.</span><span class="nx">done</span><span class="p">,</span>
    <span class="p">]);</span>
  <span class="p">}</span>

  <span class="c1">// Get all the articles in date order:</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">getAllFromIndex</span><span class="p">(</span><span class="dl">'</span><span class="s1">articles</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">date</span><span class="dl">'</span><span class="p">));</span>

  <span class="c1">// Add 'And, happy new year!' to all articles on 2019-01-01:</span>
  <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">tx</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="dl">'</span><span class="s1">articles</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">readwrite</span><span class="dl">'</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">index</span><span class="p">(</span><span class="dl">'</span><span class="s1">date</span><span class="dl">'</span><span class="p">);</span>

    <span class="k">for</span> <span class="k">await</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">cursor</span> <span class="k">of</span> <span class="nx">index</span><span class="p">.</span><span class="nx">iterate</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="dl">'</span><span class="s1">2019-01-01</span><span class="dl">'</span><span class="p">)))</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">article</span> <span class="o">=</span> <span class="p">{</span> <span class="p">...</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">value</span> <span class="p">};</span>
      <span class="nx">article</span><span class="p">.</span><span class="nx">body</span> <span class="o">+=</span> <span class="dl">'</span><span class="s1"> And, happy new year!</span><span class="dl">'</span><span class="p">;</span>
      <span class="nx">cursor</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">article</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">await</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">done</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="typescript">TypeScript</h1>

<p>This library is fully typed, and you can improve things by providing types for your database:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">openDB</span><span class="p">,</span> <span class="nx">DBSchema</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">idb</span><span class="dl">'</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">MyDB</span> <span class="kd">extends</span> <span class="nx">DBSchema</span> <span class="p">{</span>
  <span class="dl">'</span><span class="s1">favourite-number</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
    <span class="nl">key</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
    <span class="nl">value</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="nl">products</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">value</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">name</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
      <span class="nl">price</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
      <span class="nl">productCode</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="nl">key</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
    <span class="nl">indexes</span><span class="p">:</span> <span class="p">{</span> <span class="dl">'</span><span class="s1">by-price</span><span class="dl">'</span><span class="p">:</span> <span class="kr">number</span> <span class="p">};</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">demo</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">openDB</span><span class="o">&lt;</span><span class="nx">MyDB</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">'</span><span class="s1">my-db</span><span class="dl">'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">upgrade</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">db</span><span class="p">.</span><span class="nx">createObjectStore</span><span class="p">(</span><span class="dl">'</span><span class="s1">favourite-number</span><span class="dl">'</span><span class="p">);</span>

      <span class="kd">const</span> <span class="nx">productStore</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">createObjectStore</span><span class="p">(</span><span class="dl">'</span><span class="s1">products</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">keyPath</span><span class="p">:</span> <span class="dl">'</span><span class="s1">productCode</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">});</span>
      <span class="nx">productStore</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">(</span><span class="dl">'</span><span class="s1">by-price</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">price</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">},</span>
  <span class="p">});</span>

  <span class="c1">// This works</span>
  <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="dl">'</span><span class="s1">favourite-number</span><span class="dl">'</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Jen</span><span class="dl">'</span><span class="p">);</span>
  <span class="c1">// This fails at compile time, as the 'favourite-number' store expects a number.</span>
  <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="dl">'</span><span class="s1">favourite-number</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Twelve</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Jake</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To define types for your database, extend <code class="language-plaintext highlighter-rouge">DBSchema</code> with an interface where the keys are the names of your object stores.</p>

<p>For each value, provide an object where <code class="language-plaintext highlighter-rouge">value</code> is the type of values within the store, and <code class="language-plaintext highlighter-rouge">key</code> is the type of keys within the store.</p>

<p>Optionally, <code class="language-plaintext highlighter-rouge">indexes</code> can contain a map of index names, to the type of key within that index.</p>

<p>Provide this interface when calling <code class="language-plaintext highlighter-rouge">openDB</code>, and from then on your database will be strongly typed. This also allows your IDE to autocomplete the names of stores and indexes.</p>

<h2 id="opting-out-of-types">Opting out of types</h2>

<p>If you call <code class="language-plaintext highlighter-rouge">openDB</code> without providing types, your database will use basic types. However, sometimes you’ll need to interact with stores that aren’t in your schema, perhaps during upgrades. In that case you can cast.</p>

<p>Let’s say we were renaming the ‘favourite-number’ store to ‘fave-nums’:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">openDB</span><span class="p">,</span> <span class="nx">DBSchema</span><span class="p">,</span> <span class="nx">IDBPDatabase</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">idb</span><span class="dl">'</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">MyDBV1</span> <span class="kd">extends</span> <span class="nx">DBSchema</span> <span class="p">{</span>
  <span class="dl">'</span><span class="s1">favourite-number</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span> <span class="nl">key</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span> <span class="nl">value</span><span class="p">:</span> <span class="kr">number</span> <span class="p">};</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">MyDBV2</span> <span class="kd">extends</span> <span class="nx">DBSchema</span> <span class="p">{</span>
  <span class="dl">'</span><span class="s1">fave-num</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span> <span class="nl">key</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span> <span class="nl">value</span><span class="p">:</span> <span class="kr">number</span> <span class="p">};</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">openDB</span><span class="o">&lt;</span><span class="nx">MyDBV2</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">'</span><span class="s1">my-db</span><span class="dl">'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">{</span>
  <span class="k">async</span> <span class="nx">upgrade</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="nx">oldVersion</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Cast a reference of the database to the old schema.</span>
    <span class="kd">const</span> <span class="nx">v1Db</span> <span class="o">=</span> <span class="nx">db</span> <span class="k">as</span> <span class="nx">unknown</span> <span class="k">as</span> <span class="nx">IDBPDatabase</span><span class="o">&lt;</span><span class="nx">MyDBV1</span><span class="o">&gt;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">oldVersion</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">v1Db</span><span class="p">.</span><span class="nx">createObjectStore</span><span class="p">(</span><span class="dl">'</span><span class="s1">favourite-number</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">oldVersion</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">v1Db</span><span class="p">.</span><span class="nx">createObjectStore</span><span class="p">(</span><span class="dl">'</span><span class="s1">favourite-number</span><span class="dl">'</span><span class="p">);</span>
      <span class="nx">store</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">fave-num</span><span class="dl">'</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span>
<span class="p">});</span>
</code></pre></div></div>

<p>You can also cast to a typeless database by omitting the type, eg <code class="language-plaintext highlighter-rouge">db as IDBPDatabase</code>.</p>

<p>Note: Types like <code class="language-plaintext highlighter-rouge">IDBPDatabase</code> are used by TypeScript only. The implementation uses proxies under the hood.</p>

<h1 id="developing">Developing</h1>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm run dev
</code></pre></div></div>

<p>This will also perform type testing.</p>

<p>To test, navigate to <code class="language-plaintext highlighter-rouge">build/test/</code> in a browser. You’ll need to set up a <a href="https://www.npmjs.com/package/serve">basic web server</a> for this.</p>


      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
  </body>
</html>
